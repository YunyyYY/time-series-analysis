---
title: "Homework 8"
output: 
  html_document:
      theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(987654321L)
library(pomp)
library(ggplot2)
library(plyr)
library(reshape2)
theme_set(theme_bw())
```

### Question 8.1. Assessing and improving algorithmic parameters

From the diagnostic plots on slide 57 of Chapter 12, we can estimate the ranges that three parameters converge to:
\[
\left\{
\begin{array}{rl}
\beta &\in [0.004, 0.005], \\
\mu_{IR} &\in [1.5, 2.0], \\
\rho &\in [0.8, 0.85]
\end{array}
\right.
\]

Therefore, we can narrow down the parameter space in the search box:
```{r set_box, eval=FALSE}
bsflu_box <- rbind(
  Beta=c(0.004,0.005),
  mu_IR=c(1.5,2),
  rho = c(0.8,0.85)
)
```

Then we rerun the algorithm:
```{r warning=FALSE, message=FALSE, comment=''}
source('ex8_1.R')
```

As we could see, $\beta$ is converging to narrower interval $0.0040 \sim 0.0045$, but the values of $\mu_{IR}$ and $\rho$ are not further narrowed.

### Question 8.2. Finding sharp peaks in the likelihood surface

We can utilize the `runif(n, min, max)` function together with `log()` and `exp()` to achieve sampling on a logarithmic scale. We first modify the initial range of $\beta$ to $[0.001, 0.01]$ for sampling:

```{r warning=FALSE, message=FALSE, comment=''}
bsflu_box <- rbind(
  Beta=c(0.001,0.01),
  mu_I=c(0.5,2),
  rho = c(0.8,0.85)
)
```

To sample it on a log scale, we can apply the `log` function to convert the range of $\beta$ and after sampling, apply `exp()` to convert it back:

```{r warning=FALSE, message=FALSE, comment=''}
Beta=exp(runif(1,log(bsflu_box[1,1]),log(bsflu_box[1,2])))
```

Accordingly, we modify the codes in question 1 and run the script `ex8_2.R`. As we can see from the summary, the results are similar to question 8.1, but we have more samples near the lower bound and less new the upper bound, with the shape of frequency distribution corresponds to a power law.

```{r warning=FALSE, message=FALSE, comment='', fig.align='center'}
source('ex8_2.R')
```


### Question 8.3. Construct a profile likelihood

Run the script `ex8_3.R`, we have
```{r warning=FALSE, message=FALSE, comment='', fig.align='center'}
source('ex8_3.R')
```

The output suggests that $95\%$ confidence interval for $\beta$ is $(0.00364, 0.00450)$. However, due to time limit, this is only the result after 100 iterations, which might not be precise enough.

### Question 8.4

#### a. Reference: 
- `bsflu2` construction, https://github.com/ionides/531w20/blob/master/12/bsflu2.R
- Profile likelihood, https://ionides.github.io/531w18/final_project/1/final.html
- GreatLakes usage, https://ionides.github.io/531w20/cluster/STATS_531_Introduction_to_R_and_pomp_on_Great_Lakes.pdf
- Parallel computing with foreach and doParallel, https://blog.aicry.com/r-parallel-computing-in-5-minutes/index.html

#### b. Timing

It took me about 2 hours to write this homework and more than 24 hours to run the codes on Great Lakes. In the end, I have to give up the results on the Great Lakes server with `run_level=3` because completing a program is too expensive.








