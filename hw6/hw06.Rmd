---
title: "Homework 6"
output: 
  html_document:
      theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(987654321L)
library(pomp)
library(ggplot2)
library(plyr)
library(reshape2)
theme_set(theme_bw())
```

We can first load the data and get an overview of how it looks:
```{r fig.align='center',fig.width=7,fig.height=3,echo=FALSE}
dat <- read.csv("https://ionides.github.io/531w20/10/parus.csv")
plot(pop~year,data=dat,type='o')
```

#### Question 6.1. Reformulating the Ricker model

```{r}
parus <- pomp(dat,times="year",t0=1959)

# Add the process model simulator
latent <- Csnippet("N = r*N*exp(-N/k);")
parus <- pomp(parus,rprocess=discrete_time(step.fun=latent,delta.t=1),statenames="N",paramnames=c("r","k"))
```

Since the arguments for negative binomial in `Csnippet` are `size` and `prob`, we can find the relationship between `size` and `mu` to determine the formulas of arguments.

According to the R document of `rnbinom`, the relationship between `size`, `mu` and `prob` is `prob = size/(size+mu)`. Therefore, denote $s$ for `size`, we have \[
\left\{\begin{array}{l}
p = \frac{s}{s+\mu}, \\
\mu = \phi P_n
\end{array}\right.
\quad \Rightarrow \quad s = \frac{p}{1-p}\mu = \frac{\phi p}{1-p}N
\]
Denote this $\phi' = \phi p/(1-p)$, the size is proportional to $P_n$, and we can use `phi` to represent this coefficient,
```{r}
# Add the measurement model
rmeas <- Csnippet("pop = rnbinom(phi*N,p);")
dmeas <- Csnippet("lik = dnbinom(pop,phi*N,p,give_log);")  
parus <- pomp(parus,rmeasure=rmeas,dmeasure=dmeas,statenames=c("N"), paramnames=c("phi","p"))
```

After we defined 
```{r fig.align='center', fig.width=7,fig.height=3}
# simulation
coef(parus) <- c(N.0=0.1,r=30,phi=20,k=2,p=0.6)
sims <- simulate(parus,nsim=1,format="data.frame",include.data=TRUE)
ggplot(data=sims,mapping=aes(x=year,y=pop))+geom_line()+facet_wrap(~.id)
```

#### Question 6.2. Coding a new POMP model

```{r}
parus2 <- pomp(dat,times="year",t0=1959)

# Add the process model simulator
stochStep <- Csnippet("
  e = rlnorm(10.5*sigma*sigma,sigma);
  N = a*N*e/(1+b*N);
")
parus2 <- pomp(parus2,rprocess=discrete_time(step.fun=stochStep,delta.t=1), paramnames=c("a","b","sigma"),statenames=c("N","e"))
```

```{r}
# Add the measurement model
rmeas2 <- Csnippet("pop = rnbinom(phi*N,p);")
dmeas2 <- Csnippet("lik = dnbinom(pop,phi*N,p,give_log);")  
parus2 <- pomp(parus2,rmeasure=rmeas2,dmeasure=dmeas2,statenames=c("N"), paramnames=c("phi","p"))
```

```{r fig.align='center', fig.width=7,fig.height=3}
# simulation
coef(parus2) <- c(N.0=1,e.0=0,a=30,b=2,sigma=0.1,phi=20,k=2,p=0.6)
sims <- simulate(parus2,nsim=3,format="data.frame",include.data=TRUE)
ggplot(data=sims,mapping=aes(x=year,y=pop))+geom_line()+facet_wrap(~.id)
```




#### Question 6.3

a. Reference: https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Distribution-functions

b. It took me about 2 hours to finish this homework. I first spent some time understanding the relationship between process model and measurement model. Then I tried to understand the arguments of `rnbinom` in `Csnippet`, because it always generates compilation error. Then I found the reference in (a) really helpful, and set argumments accordingly. After I finished question 6.1, it took me abuot 5 minutes to finish question 6.2. In addition I spent some time varying the parameters in simulation to explore the impact they have on simulation.









